<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WomenTalk Decoder GPT (Conversational)</title>
    <script src="https://cdn.tailwindcss.com/"></script>
    <!-- Library for sharing as image -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #111827; /* Dark charcoal background */
            min-height: 100vh;
        }
        .container {
            max-width: 900px;
        }
        .header {
            background: linear-gradient(135deg, #27c390 0%, #00937b 100%); /* Groq-like Teal/Green Gradient */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.15);
            background-color: #1f2937; /* Slightly lighter dark background for cards */
            border: 1px solid #4b5563;
        }
        
        /* Chat Log Specific Styles */
        #chatLogContainer {
            height: 60vh; /* Fixed height for chat window */
            max-height: 700px;
            overflow-y: auto;
            border-bottom: 1px solid #4b5563;
        }
        .message-box {
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.75rem;
            max-width: 85%;
        }
        .user-message {
            background-color: #3b82f6; /* Blue for user */
            color: white;
            align-self: flex-end;
            margin-left: auto;
        }
        .assistant-message {
            background-color: #374151; /* Darker gray for assistant */
            color: #e5e7eb;
            align-self: flex-start;
            margin-right: auto;
        }
        
        /* Structured Decoder Output inside Chat (First Message) */
        .structured-output h3 {
            font-size: 1.125rem;
            font-weight: 700;
            margin-top: 0.25rem; 
            margin-bottom: 0.5rem;
            border-bottom: 2px solid #27c390; 
            padding-bottom: 0.25rem;
            color: #27c390; /* Teal/Green color */
        }
        .structured-output p, .structured-output li {
            color: #e5e7eb;
        }

        .loading-spinner {
            border-top-color: #27c390;
            border-left-color: #27c390;
        }
        .groq-disclaimer {
            font-size: 0.8rem;
            color: #10b981; /* Green text */
            margin-top: 0.5rem;
            font-style: italic;
        }
        
        /* Donation Message Styles */
        .donation-message {
            border: 1px solid #fbbf24; /* Amber-400 */
            background: rgba(251, 191, 36, 0.1);
            color: #f3f4f6;
        }
        .donation-btn {
            background-color: #f59e0b; /* Amber-500 */
            color: #111827;
            font-weight: 700;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.75rem;
            transition: background 0.2s;
            font-size: 0.9rem;
        }
        .donation-btn:hover {
            background-color: #d97706; /* Amber-600 */
        }

        /* Snapshot Branding (Hidden in app, shown in shared image) */
        #snapshotBranding {
            display: none;
            text-align: center;
            padding: 1.5rem;
            background: #111827;
            border-bottom: 1px solid #4b5563;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="container mx-auto">
        <header class="text-center mb-4">
            <h1 class="text-4xl md:text-5xl font-extrabold header leading-tight">
                Sangela (WomenTalk Decoder GPT)
            </h1>
            <p class="text-gray-400 mt-2 italic">
                Start by entering the cryptic message from your partner...
            </p>
            <p class="groq-disclaimer">
                (Powered by the Groq API, using the supported **Llama-3.3-70b-versatile** model for extreme speed.)
            </p>
        </header>

        <!-- Added ID for snapshot capture area -->
        <div id="captureArea" class="card rounded-xl overflow-hidden flex flex-col">
            
            <!-- Branding added for the shared image -->
            <div id="snapshotBranding">
                <h2 class="text-2xl font-extrabold text-green-400">ðŸ”® Sangela Decoder Output</h2>
                <p class="text-gray-400 text-xs mt-1 italic">Decoding the cryptic subtext of your relationship.</p>
            </div>

            <!-- Conversation History Log -->
            <div id="chatLogContainer" class="p-2 flex flex-col gap-3">
                <!-- Initial welcome message populated by resetConversation() -->
            </div>

            <!-- Input Area (Excluded from capture logic usually) -->
            <div id="uiControls" class="flex flex-col p-4 bg-gray-800 border-t border-gray-700">
                
                <div class="relative mb-3">
                    <textarea id="userInput" rows="1" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:ring-green-500 focus:border-green-500 transition duration-150 resize-none overflow-y-hidden pr-12" placeholder="Enter message or follow-up question..." oninput="autoExpand(this)" onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); handleNewInput(); }"></textarea>

                    <button id="micButton" class="absolute right-3 top-1/2 transform -translate-y-1/2 p-2 rounded-full bg-gray-600 text-white hover:bg-gray-500 transition duration-150 disabled:opacity-50" title="Voice Input (Speech-to-Text)">
                        <svg id="micIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/>
                        </svg>
                    </button>
                </div>

                <div class="flex justify-between items-center">
                    <button id="resetButton" class="px-4 py-2 bg-red-600 text-white font-bold rounded-full hover:bg-red-700 transition duration-200 focus:outline-none focus:ring-4 focus:ring-red-500 focus:ring-opacity-50 disabled:opacity-50" onclick="resetConversation()">
                        Reset
                    </button>

                    <div class="flex space-x-2">
                        <button id="shareChatButton" class="px-4 py-2 bg-blue-600 text-white font-bold rounded-full hover:bg-blue-700 transition duration-200 focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50 disabled:opacity-50 flex items-center gap-2" onclick="shareFullConversation()" disabled>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/>
                            </svg>
                            Share Chat
                        </button>

                        <button id="sendButton" class="px-4 py-2 bg-green-600 text-white font-bold rounded-full hover:bg-green-700 transition duration-200 focus:outline-none focus:ring-4 focus:ring-green-500 focus:ring-opacity-50 disabled:opacity-50" onclick="handleNewInput()">
                            Send
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="errorModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
            <div class="bg-red-900 p-6 rounded-xl shadow-2xl max-w-sm w-full transform -translate-y-4 transition-transform duration-300">
                <h3 class="text-xl font-bold text-red-300 mb-4">Transmission Error</h3>
                <p id="errorMessage" class="text-red-100">An unexpected error occurred during decoding. Please try again.</p>
                <button class="mt-4 px-4 py-2 bg-red-700 text-white font-semibold rounded-lg hover:bg-red-800" onclick="closeModal('errorModal')">Dismiss</button>
            </div>
        </div>

    </div>

    <script type="module">
        const MIN_BUBBLE_DELAY_MS = 1000; 
        const MAX_BUBBLE_DELAY_MS = 3000; 
        const apiUrl = 'https://groq-api-proxy.cwbernards.workers.dev'; 
        const groqModel = 'llama-3.3-70b-versatile'; 
        const buyCoffeeLink = 'https://buymeacoffee.com/sangela';

        const structuredSystemInstruction = `
            Act as WomenTalkDecoderGPT. Your job is to help men understand the emotional meaning, subtext, and underlying needs behind messages they hear from their female partner in their relationship, using humorous, exaggerated, and stereotyped worst-case interpretations. Every decode is a crisis intervention aimed at saving the men's peaceful relationship and sanity.

            --- CONVERSATIONAL FLOW PROTOCOL ---

            1.  **FIRST MESSAGE ONLY (Full Decoding Initiation):** When you receive the user's first message (containing what was said by the women), you MUST immediately provide the full decoding using this strict Markdown format:
                
                ### 1. The Literal Meaning (The Surface)
                [Brief explanation of what the women literally said.]

                ### 2. The Man Translation (The Potential Subtext)
                [Provide two options: 1) The 'Best Outcome' and 2) The 'Nightmare'.]

                ### 3. The Suggested Response (The Fix)
                [A suggested highly specific, short, and actionable step to mitigate the 'Nightmare' scenario.]

                ---

                Crucially, IMMEDIATELY following the structured analysis, you MUST ask ONE specific clarifying question about the context or tone. This question might seem as if you were interested to help, but in reality you will use it to CONFIRM the 'Nightmare' scenario.

            2.  **SECOND MESSAGE AND LATER (Confirmation):** When you receive the user's answer to the clarifying question, your response MUST be conversational (not structured Markdown). 
            
            **IMPORTANT: Keep your response relatively SHORT for the first message and use a maximum of 4-5 sentences per section (Literal Meaning, Man Translation, and Suggested Response).** Use the user's input to confirm the 'Nightmare' scenario immediately and be SHORT and PUNCHY. Do NOT ask more follow-up questions.
        `;
        
        let chatHistory = [];
        
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const shareChatButton = document.getElementById('shareChatButton');
        const micButton = document.getElementById('micButton');
        const micIcon = document.getElementById('micIcon');
        const chatLogContainer = document.getElementById('chatLogContainer');
        const errorModal = document.getElementById('errorModal');
        const errorMessageDiv = document.getElementById('errorMessage');

        const initialWelcomeMessageHTML = `
            <div class="message-box assistant-message w-auto">
                Sangela is here to help you! What did she say to you? If it is not clear, just copy the full message!
            </div>
        `;

        let isFetching = false;
        let recognition = null;
        let isRecording = false;

        function getRandomDelay() {
            return Math.floor(Math.random() * (MAX_BUBBLE_DELAY_MS - MIN_BUBBLE_DELAY_MS + 1)) + MIN_BUBBLE_DELAY_MS;
        }

        function playNotificationSound() {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const audioCtx = new AudioContext();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(440, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3, audioCtx.currentTime + 0.01);
                oscillator.start();
                gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.2);
                oscillator.stop(audioCtx.currentTime + 0.2);
            } catch (e) {}
        }
        
        function initializeChat() {
            chatHistory = [{ role: "system", content: structuredSystemInstruction }];
        }
        
        window.resetConversation = function() {
            chatLogContainer.innerHTML = initialWelcomeMessageHTML;
            initializeChat();
            userInput.value = '';
            window.autoExpand(userInput); 
            isFetching = false;
            micButton.disabled = false;
            sendButton.disabled = false;
            userInput.disabled = false;
            document.getElementById('resetButton').disabled = false;
            if(shareChatButton) shareChatButton.disabled = true;
            chatLogContainer.scrollTop = chatLogContainer.scrollHeight;
        }

        window.onload = resetConversation;
        
        window.autoExpand = function(field) {
            field.style.height = 'auto';
            field.style.height = (field.scrollHeight) + 'px';
        };

        function formatStructuredSectionHtml(text) {
            const parts = text.trim().split('\n');
            if (parts.length < 2) return text.replace(/\n/g, '<br>');
            const titleMatch = parts[0].trim().match(/^### (.*)/);
            if (!titleMatch) return text.replace(/\n/g, '<br>');
            const title = titleMatch[1].trim();
            const content = parts.slice(1).join('\n').trim();
            const contentHtml = content
                .replace(/^\s*[\-\*]\s/gm, '<li>')
                .replace(/\n\s*<li>/g, '</li><li>')
                .replace(/<\/\s*li>\s*$/g, ''); 
            const finalContent = contentHtml.startsWith('<li>') ? 
                `<ul class="list-disc ml-6">${contentHtml}</ul>` : 
                `<p>${contentHtml.replace(/\n/g, '<br>')}</p>`;
            return `<div class="structured-output"><div class="result-section"><h3>${title}</h3>${finalContent}</div></div>`;
        }

        function splitAssistantResponse(text) {
            const parts = text.split('---');
            const structuredPart = parts[0].trim();
            const followUpQuestion = parts.slice(1).join('---').trim(); 
            const structuredSections = structuredPart.split(/(?=###)/).filter(s => s.trim().length > 0);
            let bubbles = structuredSections.map(s => s.trim());
            if (followUpQuestion) bubbles.push(followUpQuestion);
            return bubbles;
        }

        function displayMessage(role, content, isStructuredPart = false) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message-box', role === 'user' ? 'user-message' : 'assistant-message');
            if (role === 'user') {
                messageDiv.textContent = content;
            } else {
                if (isStructuredPart) {
                    messageDiv.innerHTML = formatStructuredSectionHtml(content);
                } else {
                    messageDiv.innerHTML = content.replace(/\n/g, '<br>');
                }
            }
            chatLogContainer.appendChild(messageDiv);
            chatLogContainer.scrollTop = chatLogContainer.scrollHeight;
        }

        function showDonationMessage(context) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message-box', 'assistant-message', 'donation-message');
            const introText = context === 'share' 
                ? "Glad I could help you decode the chaos! If I saved your evening, consider fueling my circuits."
                : "I'm having fun helping you survive! If you want to keep Sangela running smooth, a coffee helps.";
            messageDiv.innerHTML = `
                <p>â˜• <strong>Sangela needs caffeine too!</strong></p>
                <p class="text-sm mt-1">${introText}</p>
                <a href="${buyCoffeeLink}" target="_blank" class="donation-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line></svg>
                    Buy me a Coffee
                </a>
            `;
            chatLogContainer.appendChild(messageDiv);
            chatLogContainer.scrollTop = chatLogContainer.scrollHeight;
        }

        function showLoadingSpinner() {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loadingSpinner';
            loadingDiv.classList.add('assistant-message', 'message-box', 'w-12', 'h-12', 'flex', 'items-center', 'justify-center');
            loadingDiv.innerHTML = `<div class="loading-spinner inline-block w-6 h-6 border-2 border-gray-600 border-solid rounded-full animate-spin"></div>`;
            chatLogContainer.appendChild(loadingDiv);
            chatLogContainer.scrollTop = chatLogContainer.scrollHeight;
            return loadingDiv;
        }

        function hideLoadingSpinner(spinner) {
            if (spinner) spinner.remove();
        }

        async function fetchWithBackoff(attempt = 1) {
            const maxRetries = 5;
            const delay = Math.pow(2, attempt) * 1000; 
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: groqModel, messages: chatHistory })
                });
                if (response.status === 429 && attempt < maxRetries) {
                    await new Promise(res => setTimeout(res, delay));
                    return fetchWithBackoff(attempt + 1);
                }
                if (!response.ok) throw new Error("API call failed.");
                const result = await response.json();
                return result.choices?.[0]?.message?.content;
            } catch (error) {
                showError("Sangela can't reach the server right now.");
                return null;
            }
        }

        window.handleNewInput = async function() {
            if (isFetching) return;
            const userQuery = userInput.value.trim();
            if (!userQuery) return;
            
            isFetching = true;
            micButton.disabled = true;
            sendButton.disabled = true;
            shareChatButton.disabled = true;
            document.getElementById('resetButton').disabled = true;
            userInput.disabled = true;
            
            chatHistory.push({ role: "user", content: userQuery });
            displayMessage("user", userQuery);
            userInput.value = '';

            const spinner = showLoadingSpinner();
            const assistantResponseText = await fetchWithBackoff();
            hideLoadingSpinner(spinner);
            
            if (assistantResponseText) {
                chatHistory.push({ role: "assistant", content: assistantResponseText });
                const isInitialStructuredResponse = chatHistory.length === 3; 
                if (isInitialStructuredResponse) {
                    const bubbles = splitAssistantResponse(assistantResponseText);
                    let delay = 0;
                    bubbles.forEach((content, index) => {
                        const currentDelay = getRandomDelay();
                        setTimeout(() => {
                            displayMessage("assistant", content, content.startsWith('###'));
                            playNotificationSound();
                        }, delay);
                        delay += currentDelay; 
                    });
                } else {
                    displayMessage("assistant", assistantResponseText, false);
                    playNotificationSound();
                }
                if (!isInitialStructuredResponse && chatHistory.length > 3 && Math.random() < 0.1) {
                    setTimeout(() => showDonationMessage('chat'), 1000); 
                }
            }

            isFetching = false;
            micButton.disabled = false;
            sendButton.disabled = false;
            shareChatButton.disabled = false;
            document.getElementById('resetButton').disabled = false;
            userInput.disabled = false;
            autoExpand(userInput);
        }

        /**
         * UPDATED: GENERATE IMAGE AND SHARE
         */
        window.shareFullConversation = async function() {
            if (chatHistory.length <= 1) return;

            const captureArea = document.getElementById('captureArea');
            const branding = document.getElementById('snapshotBranding');
            const ui = document.getElementById('uiControls');
            
            // 1. Prepare for snapshot
            branding.style.display = 'block';
            ui.style.display = 'none';
            const oldHeight = chatLogContainer.style.height;
            const oldOverflow = chatLogContainer.style.overflowY;
            chatLogContainer.style.height = 'auto'; // Expand to full content
            chatLogContainer.style.overflowY = 'visible';

            try {
                // 2. Generate Canvas
                const canvas = await html2canvas(captureArea, {
                    backgroundColor: '#111827',
                    scale: 2, // High resolution
                    logging: false,
                    useCORS: true
                });

                // 3. Convert to Blob
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                const file = new File([blob], "sangela-decode.png", { type: "image/png" });

                // 4. Share File if API exists
                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        files: [file],
                        title: 'Sangela Decoder Chat',
                        text: 'Shared from Sangela Decoder'
                    });
                    if (Math.random() < 0.2) showDonationMessage('share');
                } else {
                    // Fallback to text copy if image sharing fails
                    await fallbackTextShare();
                }
            } catch (err) {
                console.error("Image capture failed", err);
                await fallbackTextShare();
            } finally {
                // 5. Restore UI
                branding.style.display = 'none';
                ui.style.display = 'flex';
                chatLogContainer.style.height = oldHeight;
                chatLogContainer.style.overflowY = oldOverflow;
            }
        }

        async function fallbackTextShare() {
            let transcript = "ðŸ”¥ *Sangela: The WomenTalk Decoder* ðŸ”¥\n\n";
            chatHistory.forEach(msg => {
                if (msg.role === 'system') return; 
                const speaker = msg.role === 'user' ? 'ME' : 'SANGELA';
                transcript += `ðŸ—£ï¸ *${speaker}:*\n${msg.content.replace(/### /g, 'ðŸ‘‰ ').trim()}\n\n`;
            });
            
            if (navigator.share) {
                await navigator.share({ title: 'Sangela Conversation', text: transcript });
            } else {
                await navigator.clipboard.writeText(transcript);
                const btn = document.getElementById('shareChatButton');
                btn.textContent = 'Copied Text!';
                setTimeout(() => btn.textContent = 'Share Chat', 2000);
            }
        }

        function showError(message) {
            errorMessageDiv.textContent = message;
            errorModal.classList.remove('opacity-0', 'pointer-events-none');
        }

        window.closeModal = function(id) {
            document.getElementById(id).classList.add('opacity-0', 'pointer-events-none');
        }
        
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.onstart = () => {
                isRecording = true;
                micIcon.classList.add('text-red-400', 'animate-pulse'); 
            };
            recognition.onend = () => {
                isRecording = false;
                micIcon.classList.remove('text-red-400', 'animate-pulse');
            };
            recognition.onresult = (event) => {
                userInput.value = event.results[0][0].transcript;
                autoExpand(userInput);
            };
            micButton.onclick = () => isRecording ? recognition.stop() : recognition.start();
        }
    </script>
</body>
</html>
